# 分库与分表

简单来说，数据的切分就是通过某种特定的条件，将我们存放在**同一个数据库中的数据分散存放到多个数据库（主机）中，以达到分散单台设备负载的效果，即分库分表**。

## **1. 分表与分区的不同**

分表，就是讲一张表分成多个小表，这些小表拥有不同的表名；而分区是将一张表的数据分为多个区块，这些区块可以存储在同一个磁盘上，也可以存储在不同的磁盘上，这种方式下表仍然只有一个。

## **2. 使用分库与分表的原因**

随着时间和业务的发展，数据库中的表会越来越多，并且表中的数据量也会越来越大，那么读写操作的开销也会随着增大。

## **3. 垂直切分**

垂直切分是将**一张表按列切分成多个表**，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将经常被使用的列和不经常被使用的列切分到不同的表中。

将**表按功能模块、关系密切程度划分出来，部署到不同的库**上。例如，我们会建立商品数据库 payDB、用户数据库 userDB 等，分别用来存储项目与商品有关的表和与用户有关的表。

### 垂直切分的优点

- 拆分后业务清晰，拆分规则明确

- 系统之间进行整合或扩展很容易
 
- 按照成本、应用的等级、应用的类型等将表放到不同的机器上，便于管理

- 便于实现动静分离、冷热分离的数据库表的设计模式

数据维护简单

### 垂直切分的缺点

- 部分业务表无法关联（Join），只能通过接口方式解决，提高了系统的复杂度

- 受每种业务的不同限制，存在单库性能瓶颈，不易进行数据扩展和提升性能

- 事务处理复杂


## **4. 水平切分**

把表中的数据按照某种规则存储到多个结构相同的表中，例如按 id 的散列值、性别等进行划分，

### 水平切分的优点

- 单库单表的数据保持在一定的量级，有助于性能的提高
- 切分的表的结构相同，应用层改造较少，只需要增加路由规则即可
- 提高了系统的稳定性和负载能力

### 水平切分的缺点

- 切分后，数据是分散的，很难利用数据库的Join操作，跨库Join性能较差
- 拆分规则难以抽象
- 分片事务的一致性难以解决
- 数据扩容的难度和维护量极大

## **5. 垂直切分与水平切分的选择**

如果数据库中的表太多，并且项目各项业务逻辑清晰，那么垂直切分是首选。

如果数据库的表不多，但是单表的数据量很大，应该选择水平切分。

## **6. 水平切分的实现方式**

最简单的是使用 merge 存储引擎。

## **7. 分库与分表存在的问题**

- 垂直切分和水平切分的共同点
- 存在分布式事务的问题
- 存在跨节点Join的问题
- 存在跨节点合并排序、分页的问题
- 存在多数据源管理的问题

(1) 事务问题

在执行分库分表之后，由于数据存储到了不同的库上，数据库事务管理出现了困难。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价；如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。

(2) 跨库跨表连接问题

在执行了分库分表之后，难以避免会将原本逻辑关联性很强的数据划分到不同的表、不同的库上。这时，表的连接操作将受到限制，我们无法连接位于不同分库的表，也无法连接分表粒度不同的表，导致原本只需要一次查询就能够完成的业务需要进行多次才能完成。

## 常用的分库分表中间件

简单易用的组件：

- 当当sharding-jdbc
- 蘑菇街TSharding

强悍重量级的中间件：

- sharding
- TDDL Smart Client的方式（淘宝）
- Atlas(Qihoo 360)
- alibaba.cobar(是阿里巴巴（B2B）部门开发)
- MyCAT（基于阿里开源的Cobar产品而研发）
- Oceanus(58同城数据库中间件)
- OneProxy(支付宝首席架构师楼方鑫开发)
- vitess（谷歌开发的数据库中间件）