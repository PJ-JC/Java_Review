# 面试题

## 1.MySQL主从复制

主服务器上的任何修改都会保存到二进制日志Binary log里面，从服务器上启动一个I/O线程，连接到主服务器上面请求读取二进制日志，然后把读取到的二进制日志写到本地的Relay log中。从服务器上面开启一个SQL 线程定时检查Relay log，如果有有更改立即把更改的内容在本机上执行一遍。

#### 一主多从

由一个master和一个slave组成复制系统是最简单的情况。Slave之间并不相互通信，只能与master进行通信。在实际应用场景中，MySQL复制90%以上都是**一个Master复制到一个或者多个Slave的架构模式，主要用于读压力比较大的应用的数据库端廉价扩展解决方案。**

#### 主主复制

[![MySQL主从复制原理及配置实现](https://segmentfault.com/img/remote/1460000008942626?w=212&h=108)](http://photo.blog.sina.com.cn/showpic.html#blogid=821512b50101hxod&url=http://album.sina.com.cn/pic/002nHcUtgy6GESHubtX6d)

上图中，Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。在这种复制架构中，各自上运行的不是同一db，比如左边的是db1,右边的是db2，db1的从在右边反之db2的从在左边，两者互为主从，再辅助一些监控的服务还可以实现一定程度上的高可以用。

# 主从复制

主要涉及三个线程：**binlog 线程、I/O 线程和 SQL 线程。**

- binlog 线程 ：负责将**主服务器上的数据更改写入二进制文件（binlog）中**。
- I/O 线程 ：负责从**主服务器上读取二进制日志文件，并写入从服务器的中继日志中**。
- SQL 线程 ：负责**读取中继日志并重放其中的 SQL 语句**。

1. binlog输出线程:每当有从库连接到主库的时候，**主库都会创建一个线程然后发送binlog内容到从库**。

在从库里，当复制开始的时候，从库就会创建两个线程进行处理：

1. 从库I/O线程:当START SLAVE语句在从库开始执行之后，**从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。**从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件。

1. 从库的SQL线程:从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。

复制主要有三个步骤：

1. 在主库上把数据更改记录到**二进制日志**（Binary Log)中。
1. 备库将主库上的日志复制到自己的**中继日志中**（Relay Log)。
1. 备库读取中继日志中的事件，将其重放在到**备库数据之上**。

![](https://raw.githubusercontent.com/wuqifan1098/picBed/master/master-slave.png)

## 主从复制的作用（好处，或者说为什么要做主从）

1. 做数据的热备，**作为后备数据库**，主数据库服务器故障后，可切换到从数据库继续工作，**避免数据丢失**。

1. 架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，**降低磁盘I/O访问的频率，提高单个机器的I/O性能**。

1. **读写分离，使数据库能支撑更大的并发。**在报表中尤其重要。由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。

## 主从复制的原理（重中之重，面试必问）

1.数据库有个**bin-log二进制文件，记录了所有sql语句**。

2.我们的目标就是把主数据库的bin-log文件的sql语句复制过来。

3.让其在从数据的relay-log重做日志文件中再执行一次这些sql语句即可。

4.下面的主从配置就是围绕这个原理配置

## 服务器挂了怎么办

1.确保binlog全部传到从库

   方案一：使用semi sync（半同步）方式，事务提交后，必须要传到slave，事务才能算结束。对性能影响很大，依赖网络适合小tps系统。

   方案二：双写binlog，通过DBDR OS层的文件系统复制到备机，或者使用共享盘保存binlog日志。

   方案三：在数据层做文章，比如保证数据库写成功后，再异步队列的方式写一份，部分业务可以借助设计和数据流解决。

2.保证数据最小化丢失

   上面的方案设计及架构比较复杂，如果能容忍数据的丢失，可以考虑使用淘宝的TMHA复制管理工具。

   当master宕机后，TMHA会选择一个binlog接收最大的slave作为master。当原master宕机恢复后，通过binlog的逆向应用，把原master上多执行的事务回退掉。

https://blog.51cto.com/xxr007/1965600

# 读写分离

主服务器用来处理写操作以及实时性要求比较高的读操作，而从服务器用来处理读操作。

读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。

MySQL 读写分离能提高性能的原因在于：

- 主从服务器**负责各自的读和写，极大程度缓解了锁的争用**；
- 从服务器可以配置 MyISAM 引擎，提升查询性能以及节约系统开销；
- 增加冗余，**提高可用性**。